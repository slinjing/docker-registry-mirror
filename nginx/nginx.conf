worker_processes auto;
worker_rlimit_nofile 65535;  # 提升文件描述符限制，适配高并发

events {
    worker_connections 10240;  # 增大连接数上限
    use epoll;  # 启用高效事件驱动模型（Linux 专用）
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # 日志配置（记录转发详情，方便排查）
    log_format  main  '$remote_addr [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      'upstream=$upstream_addr response_time=$request_time';
    access_log  /var/log/nginx/access.log  main;
    error_log   /var/log/nginx/error.log   warn;

    # 性能优化配置
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;  # 长连接超时时间
    types_hash_max_size 2048;

    # SSL 全局配置（复用证书，简化配置）
    ssl_protocols TLSv1.2 TLSv1.3;  # 禁用不安全协议
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_session_cache shared:SSL:10m;  # SSL 会话缓存
    ssl_session_timeout 1d;  # 会话超时时间

    # HTTPS 服务配置
    server {
        listen       443 ssl;  # 启用 HTTP/2，提升传输效率
        server_name  your-domain.com;  # 与客户端 daemon.json 配置一致

        # Certbot 证书路径
        ssl_certificate      /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key  /etc/nginx/certs/privkey.pem;

        # 跨域配置（避免部分客户端工具报错）
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
        add_header Access-Control-Allow-Headers Authorization,Docker-Distribution-API-Version;

        # 1. Docker Hub 代理转发（默认路径，无仓库前缀）
        # 匹配：nginx:latest → /v2/library/nginx/manifests/latest
        location /v2/ {
            proxy_pass http://docker-hub:5000/v2/;  # 后端 docker-hub 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            # 超时配置（适配大镜像拉取，避免超时）
            proxy_connect_timeout 600s;  # 连接超时 10 分钟
            proxy_read_timeout 600s;     # 读取超时 10 分钟
            proxy_send_timeout 600s;     # 发送超时 10 分钟
            proxy_buffering on;          # 启用缓冲，提升大文件传输效率
            proxy_buffer_size 16k;       # 缓冲大小
            proxy_buffers 4 64k;         # 缓冲池配置
        }

        # 2. k8s.gcr.io 代理转发
        # 匹配：shulin.qzz.io/k8s.gcr.io/kube-apiserver:v1.19.0 → /v2/kube-apiserver/manifests/v1.19.0
        location /v2/k8s.gcr.io/ {
            proxy_pass http://k8s-gcr:5000/v2/;  # 后端 k8s-gcr 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 3. registry.k8s.io 代理转发
        location /v2/registry.k8s.io/ {
            proxy_pass http://k8s:5000/v2/;  # 后端 k8s 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 4. gcr.io 代理转发
        location /v2/gcr.io/ {
            proxy_pass http://gcr:5000/v2/;  # 后端 gcr 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 5. ghcr.io 代理转发
        location /v2/ghcr.io/ {
            proxy_pass http://ghcr:5000/v2/;  # 后端 ghcr 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 6. quay.io 代理转发
        location /v2/quay.io/ {
            proxy_pass http://quay:5000/v2/;  # 后端 quay 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 7. mcr.microsoft.com 代理转发
        location /v2/mcr.microsoft.com/ {
            proxy_pass http://mcr:5000/v2/;  # 后端 mcr 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 8. docker.elastic.co 代理转发
        location /v2/docker.elastic.co/ {
            proxy_pass http://elastic:5000/v2/;  # 后端 elastic 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 9. nvcr.io 代理转发
        location /v2/nvcr.io/ {
            proxy_pass http://nvcr:5000/v2/;  # 后端 nvcr 代理服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Docker-Distribution-API-Version $http_docker_distribution_api_version;

            proxy_connect_timeout 600s;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        # 静态文件/健康检查（可选，用于监控）
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }

    # 可选：HTTP 重定向到 HTTPS（强制加密传输）
    server {
        listen 80;
        server_name shulin.qzz.io;
        return 301 https://$host$request_uri;  # 所有 HTTP 请求重定向到 HTTPS
    }
}
